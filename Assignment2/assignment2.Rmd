---
title: "Assignment 2 - Network Modeling"
subtitle: "Group 5"
author: 
- Lorenzo Benedetti (23-956-451)
- Francesco Freni (23-955-248)
- Aristotelis Koutris (23-942-683)
- Ruben Oliveira Rodrigues (21-922-042)
date: "`r Sys.Date()`"
output: pdf_document
header-includes: 
  - \usepackage{amsmath}
  - \usepackage{graphicx}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(RSiena)
```


## Task 1 
(1) 
\begin{itemize}
\item Out-degree: 
  \begin{align*}
    s_{1i}(x) = \sum_{j}x_{ij}
  \end{align*}
\item Reciprocity:
  \begin{align*}
    s_{2i}(x) = \sum_{j}x_{ij}x_{ji}
  \end{align*}
\item Transitive reciprocated triplets effect:
  \begin{align*}
    s_{3i}(x) = \sum_{j,h}x_{ij}x_{ji}x_{ih}x_{hj}
  \end{align*}
\item Same covariate effect:
  \begin{align*}
    s_{4i}(x) = \sum_{j}x_{ij}I\{v_i = v_j\}
  \end{align*}
\end{itemize}


(2)
(i) Actor c can either add a tie to b, remove the tie to a, add a tie to d or keep the network unchanged.
\begin{figure}[ht!]
\begin{center}
\includegraphics[width=0.6\textwidth]{images/1.jpg}
\end{center}
\label{fig:1}
\end{figure}

\begin{align*}
 \resizebox{1\textwidth}{!}{$
  \frac{exp(-1.5\times 2 + 2\times 1 + 1\times 1 + 1.5\times 0)}{exp(-1.5\times 2 + 2\times 1 + 1\times 1 + 1.5\times 0) + exp(-1.5\times 0 + 2\times 0 + 1\times 0 + 1.5\times 0) + exp(-1.5\times 2 + 2\times 0 + 1\times 0 + 1.5\times 1) + exp(-1.5\times 1 + 2\times 0 + 1\times 0 + 1.5\times 0)} = 0.4087872$}
\end{align*}

(ii) Actor b can either add a tie to a, remove the tie to c, add a tie to d or keep the network unchanged.
\begin{figure}[ht!]
\begin{center}
\includegraphics[width=0.6\textwidth]{images/2.jpg}
\end{center}
\label{fig:2}
\end{figure}

\begin{align*}
 \resizebox{1\textwidth}{!}{$
  \frac{exp(-1.5\times 2 + 2\times 1 + 1\times 1 + 1.5\times 1)}{exp(-1.5\times 2 + 2\times 1 + 1\times 1 + 1.5\times 1) + exp(-1.5\times 0 + 2\times 0 + 1\times 0 + 1.5\times 0) + exp(-1.5\times 2 + 2\times 1 + 1\times 0 + 1.5\times 0) + exp(-1.5\times 1 + 2\times 0 + 1\times 0 + 1.5\times 0)} = 0.7380062$}
\end{align*}

(iii) Actor a can either remove the tie to b, add a tie to c, remove the tie to d or keep the network unchanged.
\begin{figure}[ht!]
\begin{center}
\includegraphics[width=0.6\textwidth]{images/3.jpg}
\end{center}
\label{fig:3}
\end{figure}

\begin{align*}
 \resizebox{1\textwidth}{!}{$
  \frac{exp(-1.5\times 1 + 2\times 1 + 1\times 0 + 1.5\times 0)}{exp(-1.5\times 1 + 2\times 1 + 1\times 0 + 1.5\times 0) + exp(-1.5\times 3 + 2\times 2 + 1\times 1 + 1.5\times 1) + exp(-1.5\times 1 + 2\times 0 + 1\times 0 + 1.5\times 1) + exp(-1.5\times 2 + 2\times 1 + 1\times 0 + 1.5\times 1)} = 0.1410791$}
\end{align*}

(iv) Actor a can either remove the tie to a, remove the tie to b, add a tie to c or keep the network unchanged.
\begin{figure}[ht!]
\begin{center}
\includegraphics[width=0.6\textwidth]{images/4.jpg}
\end{center}
\label{fig:4}
\end{figure}

\begin{align*}
 \resizebox{1\textwidth}{!}{$
  \frac{exp(-1.5\times 2 + 2\times 1 + 1\times 0 + 1.5\times 0)}{exp(-1.5\times 1 + 2\times 0 + 1\times 0 + 1.5\times 0) + exp(-1.5\times 1 + 2\times 1 + 1\times 0 + 1.5\times 0) + exp(-1.5\times 3 + 2\times 1 + 1\times 0 + 1.5\times 1) + exp(-1.5\times 2 + 2\times 1 + 1\times 0 + 1.5\times 0)} = 0.1410792$}
\end{align*}


## Task 2
(1)
```{r}
# Task 2.1 ----------------------------------------------------------------
# The function "simulation" simulates the network evolution between 
# two time points. 
# Given the network at time t1, denoted by x1, the function simulates the 
# steps of the continuous-time Markov chain defined by a SAOM with outdegree,
# recip and transTrip statistics. Unconditional simulation is used.
# The function returns the network at time t2.
# The structure of the algorithm is described in the file
# _Simulating from SAOM.pdf_ available in
# the Lecture notes and additional material section on Moodle.

#' Simulate the network evolution between two time points
#'
#' @param n number of actors in the network
#' @param x1 network at time t1
#' @param lambda rate parameter
#' @param beta1 outdegree parameter
#' @param beta2 reciprocity parameter
#' @param beta3 transTrip parameter
#'
#' @return network at time t2
#'
#' @examples
#' netT1 <- matrix(c(
#'   0, 1, 0, 0, 0,
#'   0, 0, 0, 1, 0,
#'   0, 0, 0, 1, 1,
#'   1, 0, 1, 0, 0,
#'   0, 1, 1, 0, 1
#'   ), 
#'   nrow = 5, ncol =  5, byrow = TRUE)
#' netT2 <- simulation(5, netT1, 4, -2, 0.5, 0.05)
simulation <- function(n, x1, lambda, beta1, beta2, beta3) {
  t <- 0 # time
  x <- x1
  while (t < 1) {
    dt <- rexp(1, n * lambda)
    i <- sample(1:n, size=1)
    
    delta_outdegree <- rep(0, n)
    delta_rec <- rep(0, n)
    delta_trans_trip <- rep(0, n)
    for (j in (1:n)) {
      if (j==i) next
      delta_outdegree[j] <- 1 - 2*x[i,j]
      delta_rec[j] <- (1 - x[i,j])*x[j,i] - x[i,j]*x[j,i]
      #if ((x[i,j]==1) & (x[j,i]==1)) {
      #  delta_rec[j] <- -1
      #} else if (x[j,i] == 1) {
      #  delta_rec[j] <- 1
      #}
      for (h in 1:n) {
        delta_trans_trip[j] <- delta_trans_trip[j] + (1-x[i,j])*x[i,h]*x[h,j] -
          x[i,j]*x[i,h]*x[h,j]
        delta_trans_trip[j] <- delta_trans_trip[j] + x[i,h]*(1-x[i,j])*x[j,h] -
          x[i,h]*x[i,j]*x[j,h]
      }
    }
    p <- exp(beta1 * delta_outdegree + beta2 * delta_rec + beta3 * delta_trans_trip) /
      sum(exp(beta1 * delta_outdegree + beta2 * delta_rec + beta3 * delta_trans_trip))
    j <- which.max(rmultinom(1, 1, prob = p))
    if (i != j) x[i,j] <- 1 - x[i,j]
    t <- t + dt
  }
  return(x)
}
```


(2)
```{r}
net1 <- as.matrix(read.csv('net1.csv', header=F))
net2 <- as.matrix(read.csv('net2.csv', header=F))

waves <- sienaDependent(array(c(net1, net2), dim=c(22, 22, 2)))
myData <- sienaDataCreate(waves)
myData
```

```{r}
myeff <- getEffects(myData)
myeff <- includeEffects(myeff, transTrip)

myAlgorithm <- sienaAlgorithmCreate(
  nsub = 2, n3 = 3000, seed = 2023
)

model0 <- siena07(myAlgorithm,
  data = myData, effects = myeff, returnDeps = TRUE,
  useCluster = TRUE, nbrNodes = 4
)
model0
```
```{r}
model0$rate
model0$theta
```

